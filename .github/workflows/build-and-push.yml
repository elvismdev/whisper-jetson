name: Build and Push to GHCR

on:
  push:
    branches: [main]
    paths:
      - "Dockerfile"
      - "app/**"
      - ".github/workflows/build-and-push.yml"

jobs:
  build:
    runs-on: [self-hosted, linux, ARM64]

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to GHCR
        run: echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u elvismdev --password-stdin

      - name: Set short SHA
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

      - name: Build image
        run: |
          docker build \
            -t ghcr.io/elvismdev/whisper-jetson:latest \
            -t ghcr.io/elvismdev/whisper-jetson:sha-${{ steps.vars.outputs.sha_short }} \
            .

      - name: Push image
        run: |
          docker push ghcr.io/elvismdev/whisper-jetson:latest
          docker push ghcr.io/elvismdev/whisper-jetson:sha-${{ steps.vars.outputs.sha_short }}

      - name: Restart whisper-asr service
        run: sudo systemctl restart whisper-asr

      - name: Remove old image tags
        if: always()
        run: |
          # Remove all sha-* tags except the one we just built
          docker images ghcr.io/elvismdev/whisper-jetson --format '{{.Repository}}:{{.Tag}}' \
            | grep ':sha-' \
            | grep -v ":sha-${{ steps.vars.outputs.sha_short }}" \
            | xargs -r docker rmi || true

      - name: Prune unused Docker data
        if: always()
        run: |
          # Remove stopped containers, dangling images, and build cache
          docker container prune -f
          docker image prune -f
          docker builder prune -f --filter "until=72h"
